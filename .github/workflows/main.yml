name: Build

on: [push, pull_request]

jobs:
  Build:
    name: ${{ matrix.platform.name }}
    runs-on: ${{ matrix.platform.os }}
    strategy:
      fail-fast: false
      matrix:
        platform:
        - { name: Windows, os: windows-latest, msvc: true }
        - { name: Linux,   os: ubuntu-latest }
        - { name: MacOS,   os: macos-latest }
    steps:
    - uses: ilammy/msvc-dev-cmd@v1
      if: ${{ matrix.platform.msvc }}
      with:
        arch: x64
    - name: Get sdl2-compat sources
      uses: actions/checkout@v3
    - name: Install Ninja
      if: ${{ !contains(matrix.platform.shell, 'msys2') }}
      uses: turtlesec-no/get-ninja@main
    - name: Set up SDL3
      uses: libsdl-org/setup-sdl@main
      with:
        cmake-generator: Ninja
        version: 3-head
        sdl-test: true
        shell: ${{ matrix.platform.shell }}
        add-to-environment: true
    - name: Set up Linux dependencies
      if: ${{ runner.os == 'Linux' }}
      run: |
        sudo apt-get update -y
        sudo apt-get install -y libgl1-mesa-dev libglu1-mesa-dev
    - name: Configure (CMake)
      shell: sh
      run: |
        cmake -B build -GNinja
    - name: Build (CMake)
      run: |
        cmake --build build/
    - name: Run build-time tests (CMake)
      if: ${{ false }} # FIXME: enable build-time tests on CI
      shell: sh
      run: |
        set -eu
        export SDL_TESTS_QUICK=1
        ctest -VV --test-dir build/
    - name: Check that versioning is consistent
      # We only need to run this once: arbitrarily use the Linux build
      if: ${{ runner.os == 'Linux' }}
      shell: bash
      run: |
        ./build-scripts/test-versioning.sh
